### 前言

AdvHD 这个引擎也算是挺常见的了，前身是 willadv（至少 vndb 上是这名字），似乎内嵌 lua 脚本是在这一代引擎才有的，现在已经更新到了大版本 1.9。

而在最新的 1.9 版本中，加入了一个语言包功能，可以在不对可执行文件进行修改的情况下原生实现汉化（当然，其他语言理论上也是可以的，只不过对简繁中文的支持明显更完善一些）。

这个功能虽然是用于官中的，但在其他使用这版引擎的游戏中也有相关代码。其实不算“新”方法了，不过据我所知，到现在还没有民间汉化组使用过该功能制作补丁，所以还是分享出来，免得各位再去改那掺了一堆 bytecode 的 ws2（记得高版本 ws2 还不好直接改，还是去玩 StringReloads 吧）。

你可以在[这里](https://github.com/vanilla-translation-group/AdvHD19_tools)获取到下面会用到的小工具，需要 Python3 环境，在部分系统下可能需要单独安装 python-tk 包。

### 语言包

创建一个语言包很简单：只需要在游戏目录下创一个文件夹，然后把 AdvHDLang.dll 拖进去，它就会被识别为语言包了。有些特殊的名字会被自动映射为对应的本地化名称，比如 zh-CN 会显示为 `中文(简体，中国)`，而其他不能被识别的名称则会维持原样显示。

在有了至少一个语言包之后，启动游戏时的设置界面就会多出选择语言包的选项，不添加任何语言包的原版则会显示为 English~~（哪怕它其实是日语）~~。

大部分时候，都会优先从语言包内的封包读取文件，可以起到覆盖原版文件的效果。实际上，你不把它当语言包用也是可以的，比如我就见过拿它来做步兵补丁的……

### 提取文本及人名

进入正题，首先需要打开游戏目录下的 Rio.arc 封包（有时候会是 Rio1），从里面解出剧本相关的 ws2 文件。注意 ws2 需要是解密过后的，比如 GARbro 在提取时会自动对 ws2 进行解密，但有些工具是不会的。

然后打开上面提到的工具（GUI 和 CLI 均可，会用就行），选 extract ws2 那个，输入文件选个 ws2，输出文件有两个，分别对应着文本和人名表，选一个合适的位置导出它们。

文本先放一边，先看人名表。这个人名表是 UTF-16LE 编码的，你需要选一个支持的文本编辑器来打开它。打开以后，会看到这样的格式：

```
原名(TAB)译名
```

只需要更改译名即可，原名和中间的 TAB 都不要动，%XX 之类的控制符也不要动。

改完以后，就可以更名为 NameTable.txt，并封包进语言包文件夹中的 Rio.arc 了。

~~什么，你问我为什么一次只处理一个文件？好吧，这其实是测试时候用的功能，如果要批量导入导出可以在这个基础上修改，反正也不难对不对？~~

### 找密钥

下面的操作中有些文件是加密的，需要一个密钥来解密它们。

这个密钥在内存中的位置是固定的，先要找到这个位置，有两个地方比较好找。

用 x32dbg 打开主程序，去搜索 `.lng` 这个字符串，往下翻；或者搜索跨模块调用中的 AddFontMemResourceEx，往上翻。你会看到一个 xor 循环，在附近应该会有一行像这样的指令：`mov dl,byte ptr ds:[XXXXXX]`，这个就是密钥所在位置了。

右键在内存窗口中转到这个常量，接着启动游戏（只需要到设置界面即可，这时候已经计算完成了），那一字节的内容就是密钥了。

如果实在找不到，也可以尝试用这个特征匹配：`8A15????5?00`。一般来说是可以的，不过要是主程序脱过壳之类的，那就不好说了。

-----

2025/2/23 更新：实际上有种更简单的方法，直接在反编译的 GameInfo.lua 中就可以找到密钥，在 getHostInfo 这个函数里写着 `L1_2 =` 的那一行后面就是（记得转成十六进制）。关于如何反编译 lua，请见后面的部分。

### 处理 lng

获取到密钥以后，就可以着手处理上面的文本了。

在这版引擎中，多语言功能是通过后缀名为 lng 的语言文件来实现的，在调用 ws2 时会自动搜索同名的 lng，如果存在则会替换文本。

文件的格式：

- 开头 4 字节，存储字符串个数
- 后面 2\*n 字节，存储字符串长度（含结束符）
- 再后面存储 UTF-16 编码并经过 xor 加密的字符串
- 所有数据均为 Little Endian，含字符串

继续使用上面的工具，用 encrypt lng 功能，把输入输出和十六进制的密钥填进去，接着就可以把输出的文件封包丢进文件夹了。**一定要注意封包需要和原来的 ws2 文件所在的封包同名！比如原来在 RIO1，那新的封包也要是这个名字，不然读不到的。**

另外解密的时候是不用输入密钥的，各位可以猜一猜为什么。

### 改 lua 之 ui\_language

到上面为止，游戏文本的相关处理已经完成了，但还需要对游戏系统所调用的 lua 做一些修改。

这一步是最简单的：只需要把下面的内容填入一个新的 ui\_language.lua 文件，并把它封包为 Script.arc，放进语言包就大功告成。需要注意的一点是，原游戏的 Script.arc 中也有一个 ui\_language.lua，但那个是不需要改的，别搞错了。

```lua
local L0_1

function L0_1()
  return 0
end

getLangPatchFlag = L0_1

function L0_1()
  g_altLanguage = true
end

setInitLang = L0_1
```

getLangPatchFlag 函数会控制一些语言相关的功能，一般来说，返回 1 代表繁体中文；返回 2 代表日文（大部分游戏里默认就是这个）；返回 3 代表简体中文。不过也有改过逻辑的，比如有些官中会返回 true。

这里返回 0，其实也是一种默认值，具体原因暂且按下不表。

而 setInitLang……好吧说实话我也不知道这是干嘛的，好像删了也没事。但官中解包的文件里都有这个函数，所以为了兼容性就留着它吧。

### 改 lua 之 GameInfo

从这里开始就要对已有的 lua 进行修改了，不过那些都是编译过后的字节码格式，所以需要一个反编译工具，下面都以 unluac 作为示例。

要使用多语言功能，需要有一个函数 getEnglishTitle，大多数原版游戏是没这个函数的，所以需要我们手动给它加上。

使用 unluac 反编译游戏文件夹下 Script.arc 中的 GameInfo.lua，在输出文件的任意位置（最好是 getAppInfo 和 getSaveInfo 中间）加上这些代码：

```lua
function L0_1()
  local L0_2
  L0_2 = "GAMETITLE"
  return L0_2
end

getEnglishTitle = L0_1
```

你可以任意修改 GAMETITLE 的内容，最好是使用游戏原名（在开头的 getAppInfo 里就会有，最新版引擎已经默认使用 UTF-8 编码了）。

然后直接塞回去原来的封包就行（最好备份一下免得改错了），游戏是可以读取没编译过的 lua 的。

### 改 lua 之 LegacyGame

还是和上面一样，从 Script.arc 里提取出 LegacyGame.lua。

其实在工具里提供了自动给 LegacyGame.lua 打补丁的功能，所以你可以直接跳过下面的说明——不过 lua 字节码的格式更为复杂，不能保证工具会不会出现什么未知的问题，所以最好还是手动操作。

使用 unluac 对 LegacyGame.lua 进行反*汇编*——注意是反汇编，不是上面的反编译，要使用 --disassemble 参数。

然后会提取出来一大堆东西，先不用管前面的，直接去找到第一个 `settabup u0 k0 k1`。在很多游戏中这一行指令会把 g\_SetDefaultLangJP 设置为 true，导致多语言功能无法被激活。

所以要把它改成 false，从上面的 constant 中找出一个值为 false 的，比如是 k50，那就把这行指令改成 `settabup u0 k0 k50`。

接下来要对一些文件名进行处理，全文搜索 Sys\_c\_ 然后批量替换为 Sys\_ 即可。或者你也可以不替换，但要保证语言包的 SysGraphic.arc 里这些文件都存在，不然要出事的。

改完以后就可以使用 --assemble 参数对它进行汇编，然后回封了。

-----

补充：对 menu\_config.lua 和 menu\_gallery.lua 也需要进行同样的操作修改文件名，注意替换时需要忽略大小写。

### 处理字体

到这，其实游戏补丁已经可以正常用了，但不难发现里面的字体很难看，而且这引擎也不给设置字体，所以要自己处理一下。

这个引擎的字体是 PTF 格式，置于 Fonts.arc 中，其实就是加密再压缩过后的 TTF。加密还是和上面一样的 xor，至于压缩，应该是 lz77 家族中的一种。

首先需要准备字体，一般来说都是 NotoSansCJKsc-Regular，但保险起见最好还是反编译 LegacyGame\_utf8.lua 看一下。可以从网上下载，也可以用官中的字体解密。

使用工具的 encrypt PTF 功能，对所选的字体进行加密（密钥还是上面找到的那个），然后放进语言包里的 Fonts.arc。~~不过你会发现加密过后文件还变大了，那是因为我没写压缩。PR welcome!~~

这样就搞定了……吗？如果现在开游戏会发现字体还是没变。回到之前的 ui\_language.lua，之前让 getLangPatchFlag 返回 0，是因为很多操作还没有完成，这个值会控制好几个东西，比如用什么字体，比如开什么文件，有兴趣的可以自己看 LegacyGame.lua 里的逻辑。

现在都处理完了，就可以把它改为 3 了。现在，所有功能应该都能正常使用了，效果可以看下面。

### 效果展示

以 [乙女とふれあう、ひとつ屋根の下 体験版](https://vndb.org/r88716) 作为示例。

![](https://s2.loli.net/2025/02/17/n6vcSifta1ypbHB.png)

### 总结

花了好几天，踩了无数坑，终于把这套方案总结出来了，希望能对各位有所帮助。回过头来看之前踩的坑有些挺明显的……不过再让我来一次也不一定能避免就是。

这上面改的仅仅是最基础的部分，对于完整的汉化补丁，还有很多东西要改或者说可以改。比如系统界面修图，设置界面中文化（改 AdvHDLang.dll 里的资源，顺便推荐一下 RisohEditor 这个开源的 Resource Hacker 替代工具），那几个 lua 里也有很多可以深究的东西。
